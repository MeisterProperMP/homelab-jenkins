# Jenkins Agent for Remote VMs
# 
# Setup Instructions:
# 1. Register agent in Jenkins UI (Manage Jenkins → Nodes → New Node)
#    - Name: Use the VM's IP address (e.g., 192.168.2.32)
#    - Label: Same as name (IP address)
#    - Launch method: "Launch agent by connecting it to the controller"
# 2. Copy the secret from Jenkins UI
# 3. Update the environment variables below
# 4. Run: docker compose up -d --build

services:
  jenkins-agent:
    build:
      context: .
      dockerfile: Dockerfile
    image: jenkins-agent-docker:latest
    container_name: jenkins-agent
    restart: unless-stopped
    
    environment:
      # Jenkins Master URL (must be reachable from this VM)
      - JENKINS_URL=http://192.168.2.31:8080
      
      # Agent name - MUST match the node name in Jenkins AND directory name in repo
      - JENKINS_AGENT_NAME=192.168.2.32
      
      # Secret from Jenkins UI (Manage Jenkins → Nodes → <agent> → Secret)
      - JENKINS_SECRET=your-secret-here
      
      # Working directory for the agent
      - JENKINS_AGENT_WORKDIR=/home/jenkins/agent
    
    volumes:
      # Agent workspace - where jobs run
      - agent_workspace:/home/jenkins/agent
      
      # home-jenkins-agent - where the deployments are handled
      - /home/jenkins-agent:/home/jenkins-agent
      
      # Docker socket - allows agent to run Docker commands
      - /var/run/docker.sock:/var/run/docker.sock
    
    # Docker socket group - must match host's docker GID
    # Check with: getent group docker
    group_add:
      - "988"

volumes:
  agent_workspace:
    name: jenkins_agent_workspace

