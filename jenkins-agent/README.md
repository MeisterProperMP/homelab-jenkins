# Jenkins Agent for Remote VMs

Docker configuration for running a Jenkins agent on remote VMs.

## Automatic Setup (Recommended)

Use the `Jenkinsfile.agent-setup` pipeline to automatically install agents. See the main [README.md](../README.md) for details.

## Files

| File | Purpose |
|------|---------|
| `Dockerfile` | Jenkins inbound-agent with Docker CLI |
| `docker-compose.yaml` | Container configuration (uses `.env` for secrets) |

## Environment Variables

The `.env` file is auto-generated by the setup pipeline:

```bash
JENKINS_URL=http://192.168.2.31:8080    # Jenkins master URL
JENKINS_AGENT_NAME=192.168.2.33          # Agent name (= VM IP)
JENKINS_SECRET=abc123...                 # Agent secret (auto-retrieved)
DOCKER_GID=988                           # Docker group GID on host
```

## Volumes

| Host Path | Container Path | Purpose |
|-----------|----------------|---------|
| `/home/jenkins-agent` | `/home/jenkins-agent` | Persistent deployment data |
| `/var/run/docker.sock` | `/var/run/docker.sock` | Docker access |

## Manual Commands

```bash
# Start agent
cd /opt/jenkins-agent
docker compose up -d --build

# View logs
docker compose logs -f

# Restart agent
docker compose restart

# Stop agent
docker compose down
```

## Troubleshooting

### Agent Won't Connect

```bash
# Check logs
docker compose logs -f

# Common issues:
# - JENKINS_URL not reachable (check firewall)
# - Port 50000 blocked
# - Wrong JENKINS_SECRET (re-run setup with FORCE_REINSTALL=true)
```

### Permission Denied on Docker

```bash
# Verify Docker GID matches
getent group docker
# Update DOCKER_GID in .env if different
```

### Test Network Connectivity

```bash
curl http://192.168.2.31:8080        # Jenkins Web UI
nc -zv 192.168.2.31 50000            # Agent port
```
