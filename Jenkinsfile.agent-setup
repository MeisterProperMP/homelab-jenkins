/*
 * Jenkins Agent Remote Installation Pipeline
 * 
 * Installs and configures a Jenkins agent on a remote VM via SSH.
 * 
 * Prerequisites:
 * 1. SSH credentials in Jenkins (Kind: "SSH Username with private key")
 * 2. Target VM has Docker and Docker Compose installed
 * 3. Target VM user has passwordless sudo (for mkdir/chown in /opt and /home)
 * 4. Jenkins master reachable from target VM on ports 8080 and 50000
 */

// Helper function: Wait for agent to connect to Jenkins
def waitForAgentConnection(String targetVm, int maxAttempts = 12, int intervalSeconds = 5) {
    echo "‚è≥ Waiting for agent to connect..."
    
    for (int attempt = 1; attempt <= maxAttempts; attempt++) {
        sleep(time: intervalSeconds, unit: 'SECONDS')
        
        try {
            def node = Jenkins.instance.getNode(targetVm)
            if (node?.toComputer()?.isOnline()) {
                echo "‚úÖ Agent connected successfully!"
                return true
            }
        } catch (Exception e) {
            // Continue waiting
        }
        
        echo "   Attempt ${attempt}/${maxAttempts}..."
    }
    
    return false
}

// Helper function: Run SSH command on target VM
def sshCmd(String command) {
    sh """
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i "\$SSH_KEY_FILE" "\${SSH_USER_PARAM}@\${TARGET_VM}" \
            "${command}"
    """
}

// Helper function: Run SSH command and return output
def sshCmdOutput(String command) {
    return sh(
        script: """
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                -i "\$SSH_KEY_FILE" "\${SSH_USER_PARAM}@\${TARGET_VM}" \
                "${command}"
        """,
        returnStdout: true
    ).trim()
}

pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        ansiColor('xterm')
    }

    parameters {
        string(
            name: 'TARGET_VM_IP',
            defaultValue: '192.168.2.',
            description: 'IP address of the target VM (e.g., 192.168.2.32)'
        )
        credentials(
            name: 'SSH_CREDENTIAL_ID',
            defaultValue: '',
            description: 'SSH credential for connecting to the target VM',
            credentialType: 'com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey',
            required: true
        )
        string(
            name: 'SSH_USER',
            defaultValue: 'Robin',
            description: 'SSH username on the target VM'
        )
        string(
            name: 'JENKINS_MASTER_URL',
            defaultValue: 'http://192.168.2.31:8080',
            description: 'Jenkins Master URL reachable from the target VM'
        )
        string(
            name: 'DOCKER_GID',
            defaultValue: '988',
            description: 'Docker group GID on the target VM (check with: getent group docker)'
        )
        string(
            name: 'AGENT_INSTALL_PATH',
            defaultValue: '/opt/jenkins-agent',
            description: 'Installation path for the agent on the target VM'
        )
        booleanParam(
            name: 'FORCE_REINSTALL',
            defaultValue: false,
            description: 'Force reinstall even if agent already exists'
        )
    }

    stages {
        stage('Validate') {
            steps {
                script {
                    // Validate parameters
                    def targetVmIp = params.TARGET_VM_IP?.trim()
                    if (!targetVmIp || !(targetVmIp ==~ /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) {
                        error "TARGET_VM_IP must be a valid IP address (e.g., 192.168.2.32)"
                    }
                    
                    if (!params.SSH_CREDENTIAL_ID?.trim()) {
                        error "SSH_CREDENTIAL_ID is required!"
                    }

                    // Store validated values in env
                    env.TARGET_VM = targetVmIp
                    env.SSH_CRED_ID = params.SSH_CREDENTIAL_ID
                    env.SSH_USER_PARAM = params.SSH_USER ?: 'Robin'
                    env.DOCKER_GID_PARAM = params.DOCKER_GID ?: '988'
                    env.INSTALL_PATH = params.AGENT_INSTALL_PATH ?: '/opt/jenkins-agent'
                    env.FORCE_REINSTALL_FLAG = params.FORCE_REINSTALL ? 'true' : 'false'
                    
                    def jenkinsUrl = params.JENKINS_MASTER_URL ?: env.JENKINS_URL ?: 'http://192.168.2.31:8080'
                    env.JENKINS_MASTER = jenkinsUrl.replaceAll('/\$', '')

                    echo """
==========================================
AGENT SETUP CONFIGURATION
==========================================
Target VM:        ${env.TARGET_VM}
SSH User:         ${env.SSH_USER_PARAM}
Jenkins Master:   ${env.JENKINS_MASTER}
Install Path:     ${env.INSTALL_PATH}
Force Reinstall:  ${env.FORCE_REINSTALL_FLAG}
=========================================="""
                }
            }
        }

        stage('Check VM') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: env.SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY_FILE',
                        usernameVariable: 'SSH_USERNAME'
                    )]) {
                        // Test SSH connection
                        echo "üîç Testing SSH connection..."
                        def sshTest = sh(
                            script: '''
                                ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \
                                    -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" 'echo OK'
                            ''',
                            returnStatus: true
                        )
                        if (sshTest != 0) {
                            error "‚ùå Cannot connect to ${env.TARGET_VM} via SSH"
                        }
                        echo "‚úÖ SSH OK"

                        // Check Docker
                        echo "üîç Checking Docker..."
                        def dockerCheck = sh(
                            script: '''
                                ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                    -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                    'docker --version && docker compose version'
                            ''',
                            returnStatus: true
                        )
                        if (dockerCheck != 0) {
                            error "‚ùå Docker or Docker Compose not installed on ${env.TARGET_VM}"
                        }
                        echo "‚úÖ Docker OK"

                        // Check agent status
                        def agentExists = sh(
                            script: '''
                                ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                    -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                    "test -f ${INSTALL_PATH}/docker-compose.yaml && echo YES || echo NO"
                            ''',
                            returnStdout: true
                        ).trim() == "YES"

                        def agentRunning = false
                        if (agentExists) {
                            agentRunning = sh(
                                script: '''
                                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                        -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                        "cd ${INSTALL_PATH} && docker compose ps --format json 2>/dev/null | grep -q jenkins-agent && echo YES || echo NO"
                                ''',
                                returnStdout: true
                            ).trim() == "YES"
                        }

                        env.AGENT_EXISTS = agentExists ? 'true' : 'false'
                        env.AGENT_RUNNING = agentRunning ? 'true' : 'false'
                        
                        echo "üìä Agent exists: ${env.AGENT_EXISTS}, Running: ${env.AGENT_RUNNING}"
                    }
                }
            }
        }

        stage('Start Existing Agent') {
            when {
                expression { 
                    env.AGENT_EXISTS == 'true' && 
                    env.AGENT_RUNNING == 'false' && 
                    env.FORCE_REINSTALL_FLAG != 'true'
                }
            }
            steps {
                script {
                    echo "üöÄ Starting existing agent..."
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: env.SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY_FILE',
                        usernameVariable: 'SSH_USERNAME'
                    )]) {
                        sh '''
                            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                "cd ${INSTALL_PATH} && docker compose up -d --build"
                        '''
                    }
                    
                    if (!waitForAgentConnection(env.TARGET_VM)) {
                        unstable("Agent started but not connected. Check logs on VM.")
                    }
                }
            }
        }

        stage('Register Node') {
            when {
                expression { 
                    env.AGENT_EXISTS != 'true' || env.FORCE_REINSTALL_FLAG == 'true'
                }
            }
            steps {
                script {
                    def nodeName = env.TARGET_VM
                    def forceReinstall = env.FORCE_REINSTALL_FLAG == 'true'
                    
                    echo "üîß Registering agent '${nodeName}'..."
                    
                    // Remove existing node if force reinstall
                    def existingNode = Jenkins.instance.getNode(nodeName)
                    if (existingNode != null) {
                        if (forceReinstall) {
                            echo "üóëÔ∏è Removing existing node..."
                            Jenkins.instance.removeNode(existingNode)
                        } else {
                            echo "‚ÑπÔ∏è Node already exists"
                        }
                    }
                    
                    // Create node if needed
                    if (Jenkins.instance.getNode(nodeName) == null) {
                        echo "‚ûï Creating node..."
                        def launcher = new hudson.slaves.JNLPLauncher(true)
                        def node = new hudson.slaves.DumbSlave(
                            nodeName, "/home/jenkins/agent", launcher
                        )
                        node.setNodeDescription("Homelab Agent for ${nodeName}")
                        node.setNumExecutors(2)
                        node.setMode(hudson.model.Node.Mode.EXCLUSIVE)
                        node.setLabelString(nodeName)
                        node.setRetentionStrategy(new hudson.slaves.RetentionStrategy.Always())
                        Jenkins.instance.addNode(node)
                        echo "‚úÖ Node created"
                    }
                    
                    // Get agent secret
                    def node = Jenkins.instance.getNode(nodeName)
                    def computer = node?.toComputer()
                    if (computer instanceof hudson.slaves.SlaveComputer) {
                        env.AGENT_SECRET = computer.getJnlpMac()
                        echo "üîë Secret retrieved"
                    } else {
                        error "Could not retrieve agent secret"
                    }
                }
            }
        }

        stage('Deploy & Start') {
            when {
                expression { 
                    env.AGENT_EXISTS != 'true' || env.FORCE_REINSTALL_FLAG == 'true'
                }
            }
            steps {
                checkout scm
                
                script {
                    // Verify files exist
                    if (!fileExists('jenkins-agent/docker-compose.yaml') || !fileExists('jenkins-agent/Dockerfile')) {
                        error "jenkins-agent/docker-compose.yaml or Dockerfile not found!"
                    }
                    
                    // Create .env file
                    writeFile file: '.env.agent', text: """# Auto-generated
JENKINS_URL=${env.JENKINS_MASTER}
JENKINS_AGENT_NAME=${env.TARGET_VM}
JENKINS_SECRET=${env.AGENT_SECRET}
DOCKER_GID=${env.DOCKER_GID_PARAM}
"""
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: env.SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY_FILE',
                        usernameVariable: 'SSH_USERNAME'
                    )]) {
                        // Create directories
                        echo "üìÅ Creating directories..."
                        sh '''
                            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                "sudo mkdir -p ${INSTALL_PATH} /home/jenkins-agent && sudo chown \$USER:\$USER ${INSTALL_PATH} /home/jenkins-agent"
                        '''
                        
                        // Stop existing agent
                        sh '''
                            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                "cd ${INSTALL_PATH} && docker compose down 2>/dev/null || true"
                        '''
                        
                        // Copy files
                        echo "üì§ Copying files..."
                        sh '''
                            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                -i "$SSH_KEY_FILE" \
                                jenkins-agent/Dockerfile \
                                jenkins-agent/docker-compose.yaml \
                                .env.agent \
                                "${SSH_USER_PARAM}@${TARGET_VM}:${INSTALL_PATH}/"
                            
                            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                "mv ${INSTALL_PATH}/.env.agent ${INSTALL_PATH}/.env"
                        '''
                        
                        // Start agent
                        echo "üöÄ Starting agent..."
                        sh '''
                            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                "cd ${INSTALL_PATH} && docker compose up -d --build"
                        '''
                    }
                    
                    sh "rm -f .env.agent"
                    
                    // Wait for connection
                    if (!waitForAgentConnection(env.TARGET_VM, 24, 5)) {
                        // Show logs on failure
                        withCredentials([sshUserPrivateKey(
                            credentialsId: env.SSH_CRED_ID,
                            keyFileVariable: 'SSH_KEY_FILE',
                            usernameVariable: 'SSH_USERNAME'
                        )]) {
                            echo "‚ö†Ô∏è Agent not connected. Logs:"
                            sh '''
                                ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                    -i "$SSH_KEY_FILE" "${SSH_USER_PARAM}@${TARGET_VM}" \
                                    "cd ${INSTALL_PATH} && docker compose logs --tail=30" || true
                            '''
                        }
                        unstable("Agent deployed but not connected. Check logs.")
                    }
                }
            }
        }

        stage('Verify') {
            steps {
                script {
                    def node = Jenkins.instance.getNode(env.TARGET_VM)
                    def isOnline = node?.toComputer()?.isOnline() ?: false
                    
                    if (isOnline) {
                        echo """
==========================================
‚úÖ AGENT READY
==========================================
Name:    ${env.TARGET_VM}
Label:   ${env.TARGET_VM}
Status:  ONLINE
=========================================="""
                    } else {
                        echo """
==========================================
‚ö†Ô∏è AGENT OFFLINE
==========================================
Check: ssh ${env.SSH_USER_PARAM}@${env.TARGET_VM}
       cd ${env.INSTALL_PATH} && docker compose logs -f
=========================================="""
                    }
                }
            }
        }
    }

    post {
        success { echo "üéâ Agent setup completed!" }
        unstable { echo "‚ö†Ô∏è Agent setup completed with warnings" }
        failure { echo "üí• Agent setup failed!" }
        cleanup { sh "rm -f .env.agent 2>/dev/null || true" }
    }
}
